# 代码分析答案

## PageId 结构体设计

### PageId::fd 和 PageId::page_no 的含义

1. **PageId::fd**：Page所在的磁盘文件开启后的文件描述符，用来定位打开的文件在内存中的位置。它是操作系统分配给打开文件的唯一标识符，通过这个文件描述符可以对文件进行读写操作。

2. **PageId::page_no**：页面在文件中的页号，标识这个页面在文件中的逻辑位置。每个文件中的页面都有一个唯一的编号，从0开始递增。

## DiskManager 类设计

### 1. path2fd_ 的作用

`path2fd_` 是一个从文件路径到文件描述符的哈希表映射（`std::unordered_map<std::string, int>`）。它的作用是：

- 记录当前已经打开的文件路径及其对应的文件描述符
- 用于快速查找某个文件路径是否已经被打开
- 防止重复打开同一个文件
- 在需要根据文件路径获取文件描述符时提供快速查找

### 2. fd2path_ 的作用

`fd2path_` 是一个从文件描述符到文件路径的哈希表映射（`std::unordered_map<int, std::string>`）。它的作用是：

- 记录当前打开的文件描述符及其对应的文件路径
- 用于根据文件描述符快速获取对应的文件路径
- 在关闭文件时，可以通过文件描述符找到对应的路径，便于清理映射关系
- 提供从文件描述符到文件路径的反向查找功能

### 3. path2fd_ 和 fd2path_ 的关系

这两个映射表是互为反向映射的关系：

- `path2fd_` 提供从路径到文件描述符的映射
- `fd2path_` 提供从文件描述符到路径的映射
- 它们共同维护着当前打开文件的双向索引
- 当打开文件时，会同时更新这两个映射表
- 当关闭文件时，会同时从这两个映射表中删除对应的记录
- 这种设计使得可以高效地进行双向查找，既可以通过路径找到文件描述符，也可以通过文件描述符找到路径

### 4. fd2pageno_ 的作用

`fd2pageno_` 是一个原子整型数组（`std::atomic<page_id_t> fd2pageno_[MAX_FD]`）。它的作用是：

- 记录每个文件中已经分配的页面个数
- 数组的索引是文件描述符，数组的值是该文件下一个要分配的页面编号
- 用于页面分配时确定新页面的编号
- 采用原子类型保证线程安全，支持并发访问
- 在 `allocate_page` 函数中，通过 `fd2pageno_[fd]++` 实现简单的自增分配策略
- 初始值为0，表示文件从第0页开始分配